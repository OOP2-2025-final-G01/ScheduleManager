<!doctype html>
<html lang="ja">

	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Schedule Manager - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
		<link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
	</head>
	<body>
		<div class="container">
			<header class="header">
				<h1>Schedule Manager - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
			</header>

			<main class="top-area">
				<div class="top-grid">
					<section class="panel">
						<h2 id="todayTitle">ä»Šæ—¥ã®äºˆå®š</h2>
						<p>ã“ã“ã« Bã•ã‚“ï¼ˆTODOï¼‰ã‹ã‚‰æ¸¡ã•ã‚ŒãŸä»Šæ—¥ã®äºˆå®šãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ï¼ˆä¾‹ï¼šè‹±èª 30åˆ†ï¼‰</p>
					</section>

					<aside class="panel">
						{% if tasks %}
							<ul style="padding-left: 20px; margin: 0; color: #c0392b; font-weight: bold;">
								{% for task in tasks %}
									<li style="margin-bottom: 8px;">
										{{ task.task }}
										<span style="font-size: 0.8rem; color: #666; font-weight: normal;">(æœŸé™: {{ task.due_date }})</span>
									</li>
								{% endfor %}
							</ul>
						{% else %}
							<p style="color: #27ae60; margin: 0;">ğŸ‰ ã‚„ã‚Šæ®‹ã—ã¯ã‚ã‚Šã¾ã›ã‚“ï¼</p>
						{% endif %}
					</aside>
				</div>
			</main>

			<section class="calendar-area">
				<div class="calendar" id="calendarRoot">
					<div class="cal-header">
						<div class="title" id="calTitle">Loading...</div>
						<div class="cal-controls">
							<button id="prevBtn">â—€</button>
							<button id="nextBtn">â–¶</button>
						</div>
					</div>

					<div class="weekdays">
						<div>æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div>åœŸ</div>
					</div>

					<div class="days" id="daysGrid"></div>

					<!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ä¸­å¤®ã€œä¸‹ã«æœˆé–“é”æˆç‡ã¨ç§‘ç›®åˆ¥æ™‚é–“ã®ã‚°ãƒ©ãƒ•ã‚’é‡ã­ã¦è¡¨ç¤º -->
					<div class="calendar-charts">
						<div class="chart-box">
							<canvas id="completionChart" width="160" height="120"></canvas>
							<div class="chart-label">ä»Šæœˆã®é”æˆç‡</div>
						</div>
						<div class="chart-box">
							<canvas id="subjectChart" width="160" height="120"></canvas>
							<div class="chart-label">ç§‘ç›®åˆ¥æ™‚é–“å‰²åˆ</div>
						</div>
					</div>
				</div>
			</section>
		</div>

		<script>
			(function(){
				const titleEl = document.getElementById('calTitle');
				const daysGrid = document.getElementById('daysGrid');
				const prevBtn = document.getElementById('prevBtn');
				const nextBtn = document.getElementById('nextBtn');
				const todayTitleEl = document.getElementById('todayTitle');

				const today = new Date();
				const todayYear = today.getFullYear();
				const todayMonth = today.getMonth();
				const todayDate = today.getDate();

				todayTitleEl.textContent = `ä»Šæ—¥ã®äºˆå®š (${todayMonth + 1}æœˆ${todayDate}æ—¥)`;

				let current = new Date();
				current.setDate(1);

				function render(monthDate){
					daysGrid.innerHTML = '';
					const year = monthDate.getFullYear();
					const month = monthDate.getMonth();
					titleEl.textContent = `${year}å¹´ ${month+1}æœˆ`;

					const firstDay = new Date(year, month, 1).getDay();
					const daysInMonth = new Date(year, month+1, 0).getDate();
					const prevDays = new Date(year, month, 0).getDate();

					const totalCells = 42;

					for(let i=0; i<totalCells; i++){
						const cell = document.createElement('div');
						cell.className = 'day';

						const dayNumber = i - firstDay + 1;
						const dateEl = document.createElement('div');
						dateEl.className = 'date';

						let targetDate;
						if(i < firstDay){
							const d = prevDays - (firstDay - 1 - i);
							dateEl.textContent = d;
							cell.classList.add('other-month');
							targetDate = new Date(year, month - 1, d);
						} else if(dayNumber > daysInMonth){
							const d = dayNumber - daysInMonth;
							dateEl.textContent = d;
							cell.classList.add('other-month');
							targetDate = new Date(year, month + 1, d);
						} else {
							dateEl.textContent = dayNumber;
							if(year === todayYear && month === todayMonth && dayNumber === todayDate){
								cell.classList.add('today');
							}
							targetDate = new Date(year, month, dayNumber);
						}

						cell.appendChild(dateEl);
						cell.addEventListener('click', function(){
							const yyyy = targetDate.getFullYear();
							const mm = String(targetDate.getMonth() + 1).padStart(2, '0');
							const dd = String(targetDate.getDate()).padStart(2, '0');
							const selectedDate = `${yyyy}-${mm}-${dd}`;
							window.location.href = `/due_date/${selectedDate}`;
						});

						daysGrid.appendChild(cell);
					}
				}

				prevBtn.addEventListener('click', ()=>{ current.setMonth(current.getMonth() - 1); render(current); });
				nextBtn.addEventListener('click', ()=>{ current.setMonth(current.getMonth() + 1); render(current); });
				render(current);
			})();
		</script>

		<!-- Chart.js CDN -->
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script>
			(function(){
				const canvas = document.getElementById('completionChart');
				if(!canvas) return;

				function drawChart(completed, total){
					const notDone = Math.max(total - completed, 0);
					const percent = total === 0 ? 0 : Math.round((completed/total)*100);
					if(canvas._chartInstance) canvas._chartInstance.destroy();
					const ctx = canvas.getContext('2d');
					canvas._chartInstance = new Chart(ctx, {
						type: 'doughnut',
						data: { labels:['é”æˆ','æœªé”æˆ'], datasets:[{ data:[completed, notDone], backgroundColor:['#2ecc71','#e74c3c'] }] },
						options: { cutout: '70%', plugins:{ legend:{ display:false }, tooltip:{ enabled:true } }, maintainAspectRatio:false }
					});
					const parent = canvas.parentNode; parent.style.position='relative';
					let badge = parent.querySelector('.chart-center-badge');
					if(!badge){ badge = document.createElement('div'); badge.className='chart-center-badge'; badge.style.position='absolute'; badge.style.left='50%'; badge.style.top='50%'; badge.style.transform='translate(-50%,-50%)'; badge.style.fontWeight='700'; badge.style.color='#222'; parent.appendChild(badge); }
					badge.textContent = total === 0 ? 'ãƒ‡ãƒ¼ã‚¿ç„¡ã—' : percent + '%';
				}

				fetch('/api/stats/monthly').then(r=>r.json()).then(json=>{ drawChart(json.completed, json.total); }).catch(e=>{ console.error('stats fetch error', e); drawChart(0,0); });
			})();

			(function(){
				const canvas = document.getElementById('subjectChart'); if(!canvas) return;
				function drawSubject(series){ if(canvas._chartInstance) canvas._chartInstance.destroy(); const labels = series.map(s=>s.subject||'æœªåˆ†é¡'); const data = series.map(s=>s.total||0); const colors = ['#3498db','#9b59b6','#f1c40f','#e67e22','#1abc9c','#95a5a6']; const ctx = canvas.getContext('2d'); canvas._chartInstance = new Chart(ctx, { type:'doughnut', data:{ labels:labels, datasets:[{ data:data, backgroundColor:colors }] }, options:{ plugins:{ legend:{ position:'bottom', labels:{ boxWidth:10 } } }, maintainAspectRatio:false } }); const total = data.reduce((a,b)=>a+b,0); const parent = canvas.parentNode; parent.style.position='relative'; let badge = parent.querySelector('.subject-center'); if(!badge){ badge = document.createElement('div'); badge.className='subject-center'; badge.style.position='absolute'; badge.style.left='50%'; badge.style.top='50%'; badge.style.transform='translate(-50%,-50%)'; badge.style.fontSize='0.9rem'; badge.style.fontWeight='700'; badge.style.color='#222'; parent.appendChild(badge); } badge.textContent = total === 0 ? 'ãƒ‡ãƒ¼ã‚¿ç„¡ã—' : total + 'åˆ†'; }

				fetch('/api/stats/subject_time').then(r=>r.json()).then(json=>{ if(json.series && json.series.length>0) drawSubject(json.series); else drawSubject([]); }).catch(e=>{ console.error('subject stats fetch error', e); drawSubject([]); });
			})();
		</script>
	</body>

</html>