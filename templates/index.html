<!doctype html>
<html lang="ja">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Schedule Manager - ダッシュボード</title>
		<style>
			/* 全体レイアウト：上部がダッシュボード（2/3相当）、下部がカレンダー（約1/3） */
			html, body { height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif; color:#222; }
			.container { display: flex; flex-direction: column; height: 100vh; }
			.header { background: linear-gradient(90deg,#34495e,#2c3e50); color: #fff; padding: 16px 20px; }
			.header h1 { margin: 0; font-size: 1.2rem; }

			/* 上部コンテンツ */
			.top-area { flex: 0 0 auto; padding: 12px 12px 8px 12px; overflow: visible; background: #fff; }
			.top-grid { display: grid; grid-template-columns: 1fr 320px; gap: 16px; }
			.panel { background: #fafafa; border: 1px solid #e6e6e6; padding: 12px; border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
			
			/* ★見出しの下線を削除 */
			.panel h2 { margin-top: 0; font-size: 1.1rem; }

			/* カレンダー部分 */
			.calendar-area { height: 33vh; min-height: 200px; max-height: 40vh; border-top: 1px solid rgba(224,224,224,0.7); background: #f7f9fb; padding: 8px 12px; box-sizing: border-box; margin-top: 0; }
			.calendar { height: 100%; display:flex; flex-direction:column; }
			.cal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
			.cal-header .title { font-weight: 600; }
			.cal-controls button { background: #2c3e50; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; margin-left:6px; }
			.weekdays { display:grid; grid-template-columns: repeat(7,1fr); text-align:center; font-weight:600; color:#555; margin-bottom:6px; }
			.days { display:grid; grid-template-columns: repeat(7,1fr); grid-auto-rows: 1fr; gap:6px; flex:1; }
			.day { background: white; border:1px solid #e6e6e6; border-radius:6px; padding:6px; box-sizing:border-box; font-size:0.9rem; display:flex; flex-direction:column; }
			.day .date { font-weight:600; margin-bottom:6px; }
			.day.other-month { opacity:0.45; }

			/* 今日の日付の強調スタイル */
			.day.today {
				background-color: #fffde7;
				border: 2px solid #fbc02d;
			}

			@media (max-width:700px){ .top-grid { grid-template-columns: 1fr; } }
		</style>
	</head>
	<body>
		<div class="container">
			<header class="header">
				<h1>Schedule Manager - ダッシュボード</h1>
			</header>

			<main class="top-area">
				<div class="top-grid">
					<section class="panel">
						<h2 id="todayTitle">今日の予定</h2>
						<p>ここに Bさん（TODO）から渡された今日の予定が表示されます。（例：英語 30分）</p>
					</section>

					<aside class="panel">
						<h3>昨日のやり残し</h3>
						<p>Dさんの追跡結果により、未完了タスクをここに注意表示します。</p>
					</aside>
				</div>
			</main>

			<section class="calendar-area">
				<div class="calendar" id="calendarRoot">
					<div class="cal-header">
						<div class="title" id="calTitle">Loading...</div>
						<div class="cal-controls">
							<button id="prevBtn">◀</button>
							<button id="nextBtn">▶</button>
						</div>
					</div>
					<div class="weekdays">
						<div>日</div><div>月</div><div>火</div><div>水</div><div>木</div><div>金</div><div>土</div>
					</div>
					<div class="days" id="daysGrid"></div>
				</div>
			</section>
		</div>

		<script>
        (function(){
            const titleEl = document.getElementById('calTitle');
            const daysGrid = document.getElementById('daysGrid');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const todayTitleEl = document.getElementById('todayTitle');

            const today = new Date();
            const todayYear = today.getFullYear();
            const todayMonth = today.getMonth();
            const todayDate = today.getDate();

            todayTitleEl.textContent = `今日の予定 (${todayMonth + 1}月${todayDate}日)`;

            let current = new Date();
            current.setDate(1);

            function render(monthDate){
                daysGrid.innerHTML = '';
                const year = monthDate.getFullYear();
                const month = monthDate.getMonth();
                titleEl.textContent = `${year}年 ${month+1}月`;

                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month+1, 0).getDate();
                const prevDays = new Date(year, month, 0).getDate();

                const totalCells = 42;

                for(let i=0; i<totalCells; i++){
                    const cell = document.createElement('div');
                    cell.className = 'day';

                    const dayNumber = i - firstDay + 1;
                    const dateEl = document.createElement('div');
                    dateEl.className = 'date';

                    // クリック時に飛ばす日付を正しく計算するためのDateオブジェクト
                    let targetDate;

                    if(i < firstDay){
                        // 前月の日付
                        const d = prevDays - (firstDay - 1 - i);
                        dateEl.textContent = d;
                        cell.classList.add('other-month');
                        targetDate = new Date(year, month - 1, d);
                    } else if(dayNumber > daysInMonth){
                        // 翌月の日付
                        const d = dayNumber - daysInMonth;
                        dateEl.textContent = d;
                        cell.classList.add('other-month');
                        targetDate = new Date(year, month + 1, d);
                    } else {
                        // 今月の日付
                        dateEl.textContent = dayNumber;
                        if(year === todayYear && month === todayMonth && dayNumber === todayDate){
                            cell.classList.add('today');
                        }
                        targetDate = new Date(year, month, dayNumber);
                    }

                    cell.appendChild(dateEl);

                    // クリックイベント
                    cell.addEventListener('click', function(){
                        const yyyy = targetDate.getFullYear();
                        const mm = String(targetDate.getMonth() + 1).padStart(2, '0');
                        const dd = String(targetDate.getDate()).padStart(2, '0');

                        const selectedDate = `${yyyy}-${mm}-${dd}`;

                        // 生成されたURLをコンソールで確認用
                        console.log("Redirecting to:", `/due_date/${selectedDate}`);

                        // Flaskのルーティングへ遷移
                        window.location.href = `/due_date/${selectedDate}`;
                    });

                    daysGrid.appendChild(cell);
                }
            }

            prevBtn.addEventListener('click', ()=>{ current.setMonth(current.getMonth() - 1); render(current); });
            nextBtn.addEventListener('click', ()=>{ current.setMonth(current.getMonth() + 1); render(current); });

            render(current);
        })();
		</script>
	</body>
</html>