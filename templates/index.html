<!doctype html>
<html lang="ja">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Schedule Manager - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
		<style>
			/* å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼šä¸Šéƒ¨ãŒãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆ2/3ç›¸å½“ï¼‰ã€ä¸‹éƒ¨ãŒã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆç´„1/3ï¼‰ */
			html, body { height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif; color:#222; }
			.container { display: flex; flex-direction: column; height: 100vh; }
			.header { background: linear-gradient(90deg,#34495e,#2c3e50); color: #fff; padding: 16px 20px; }
			.header h1 { margin: 0; font-size: 1.2rem; }

			/* ä¸Šéƒ¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
			.top-area { flex: 0 0 auto; padding: 12px 12px 8px 12px; overflow: visible; background: #fff; }
			.top-grid { display: grid; grid-template-columns: 1fr 320px; gap: 16px; }
			.panel { background: #fafafa; border: 1px solid #e6e6e6; padding: 12px; border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
			
			/* â˜…è¦‹å‡ºã—ã®ä¸‹ç·šã‚’å‰Šé™¤ */
			.panel h2 { margin-top: 0; font-size: 1.1rem; }

			/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼éƒ¨åˆ† */
			.calendar-area { height: 33vh; min-height: 200px; max-height: 40vh; border-top: 1px solid rgba(224,224,224,0.7); background: #f7f9fb; padding: 8px 12px; box-sizing: border-box; margin-top: 0; }
			/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é ˜åŸŸã‚’ relative ã«ã—ã¦ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤é…ç½®ã‚’å¯èƒ½ã«ã™ã‚‹ */
			.calendar-area { position: relative; }
			.calendar { height: 100%; display:flex; flex-direction:column; padding-bottom: 160px; }
			.cal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
			.cal-header .title { font-weight: 600; }
			.cal-controls button { background: #2c3e50; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; margin-left:6px; }
			.weekdays { display:grid; grid-template-columns: repeat(7,1fr); text-align:center; font-weight:600; color:#555; margin-bottom:6px; }
			.days { display:grid; grid-template-columns: repeat(7,1fr); grid-auto-rows: 1fr; gap:6px; flex:1; }
			.day { background: white; border:1px solid #e6e6e6; border-radius:6px; padding:6px; box-sizing:border-box; font-size:0.9rem; display:flex; flex-direction:column; }
			.day .date { font-weight:600; margin-bottom:6px; }
			.day.other-month { opacity:0.45; }

			/* ä»Šæ—¥ã®æ—¥ä»˜ã®å¼·èª¿ã‚¹ã‚¿ã‚¤ãƒ« */
			.day.today {
				background-color: #fffde7;
				border: 2px solid #fbc02d;
			}

			/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å³ä¸‹ã«è¡¨ç¤ºã™ã‚‹ã‚°ãƒ©ãƒ•ç”¨ã‚³ãƒ³ãƒ†ãƒŠ */
			.calendar-chart {
				position: absolute;
				right: -8px; /* å³ç«¯ã‹ã‚‰ã¯ã¿å‡ºã™ */
				left: auto;
				bottom: 18px; /* ä¸‹ç«¯ã«å¯„ã›ã‚‹ */
				width: 160px; /* ä¸€å›ã‚Šå¤§ãã */
				height: 128px;
				background: rgba(255,255,255,0.98);
				border-radius: 8px;
				display:flex;
				flex-direction:column;
				align-items:center;
				justify-content:center;
				box-shadow: 0 8px 22px rgba(0,0,0,0.10);
				padding:8px;
				box-sizing:border-box;
				z-index: 9999;
			}

			.calendar-chart canvas { width: 100% !important; height: auto !important; }
			.calendar-chart canvas { max-width: 140px; }

			.calendar-chart .chart-label { font-size:0.7rem; color:#555; margin-top:6px; }

			@media (max-width:700px){ .top-grid { grid-template-columns: 1fr; } }
		</style>
	</head>
	<body>
		<div class="container">
			<header class="header">
				<h1>Schedule Manager - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
			</header>

			<main class="top-area">
				<div class="top-grid">
					<section class="panel">
						<h2 id="todayTitle">ä»Šæ—¥ã®äºˆå®š</h2>
						<p>ã“ã“ã« Bã•ã‚“ï¼ˆTODOï¼‰ã‹ã‚‰æ¸¡ã•ã‚ŒãŸä»Šæ—¥ã®äºˆå®šãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ï¼ˆä¾‹ï¼šè‹±èª 30åˆ†ï¼‰</p>
					</section>


					<aside class="panel">
						{% if tasks %}
							<ul style="padding-left: 20px; margin: 0; color: #c0392b; font-weight: bold;">
								{% for task in tasks %}
									<li style="margin-bottom: 8px;">
										{{ task.task }} 
										<span style="font-size: 0.8rem; color: #666; font-weight: normal;">
											(æœŸé™: {{ task.due_date }})
										</span>
									</li>
								{% endfor %}
							</ul>
						{% else %}
							<p style="color: #27ae60; margin: 0;">ğŸ‰ ã‚„ã‚Šæ®‹ã—ã¯ã‚ã‚Šã¾ã›ã‚“ï¼</p>
						{% endif %}
					</aside>

				</div>
			</main>

			<section class="calendar-area">
				<div class="calendar" id="calendarRoot">
					<div class="cal-header">
						<div class="title" id="calTitle">Loading...</div>
						<div class="cal-controls">
							<button id="prevBtn">â—€</button>
							<button id="nextBtn">â–¶</button>
						</div>
					</div>
					<div class="weekdays">
						<div>æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div>åœŸ</div>
					</div>
					<div class="days" id="daysGrid"></div>
				</div>
				
					<!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å³ä¸‹ã«æœˆé–“é”æˆç‡ã‚°ãƒ©ãƒ•ã‚’é‡ã­ã¦è¡¨ç¤º -->
					<div class="calendar-chart">
						<canvas id="completionChart" width="160" height="120"></canvas>
						<div class="chart-label">ä»Šæœˆã®é”æˆç‡</div>
					</div>
				</section>
		</div>

		<script>
			(function(){
				const titleEl = document.getElementById('calTitle');
				const daysGrid = document.getElementById('daysGrid');
				const prevBtn = document.getElementById('prevBtn');
				const nextBtn = document.getElementById('nextBtn');
				const todayTitleEl = document.getElementById('todayTitle');

				const today = new Date();
				const todayYear = today.getFullYear();
				const todayMonth = today.getMonth();
				const todayDate = today.getDate();

				todayTitleEl.textContent = `ä»Šæ—¥ã®äºˆå®š (${todayMonth + 1}æœˆ${todayDate}æ—¥)`;

				let current = new Date();
				current.setDate(1);

				function render(monthDate){
					daysGrid.innerHTML = '';
					const year = monthDate.getFullYear();
					const month = monthDate.getMonth();
					titleEl.textContent = `${year}å¹´ ${month+1}æœˆ`;

					const firstDay = new Date(year, month, 1).getDay();
					const daysInMonth = new Date(year, month+1, 0).getDate();
					const prevDays = new Date(year, month, 0).getDate();

					const totalCells = 42;

					for(let i=0;i<totalCells;i++){
						const cell = document.createElement('div');
						cell.className = 'day';

						const dayNumber = i - firstDay + 1;
						const dateEl = document.createElement('div');
						dateEl.className = 'date';

						if(i < firstDay){
							const d = prevDays - (firstDay - 1 - i);
							dateEl.textContent = d;
							cell.classList.add('other-month');
						} else if(dayNumber > daysInMonth){
							dateEl.textContent = dayNumber - daysInMonth;
							cell.classList.add('other-month');
						} else {
							dateEl.textContent = dayNumber;
							if(year === todayYear && month === todayMonth && dayNumber === todayDate){
								cell.classList.add('today');
							}
						}

						cell.appendChild(dateEl);
						cell.addEventListener('click', function(){
							const d = new Date(year, month, Math.min(Math.max(dayNumber,1),daysInMonth));
							alert(`${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()} ã‚’é¸æŠã—ã¾ã—ãŸ`);
						});

						daysGrid.appendChild(cell);
					}
				}

				prevBtn.addEventListener('click', ()=>{ current.setMonth(current.getMonth() - 1); render(current); });
				nextBtn.addEventListener('click', ()=>{ current.setMonth(current.getMonth() + 1); render(current); });

				render(current);
			})();
		</script>
    
		<!-- Chart.js CDN -->
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script>
			(function(){
				const canvas = document.getElementById('completionChart');
				if(!canvas) return;

				function drawChart(completed, total){
					const notDone = Math.max(total - completed, 0);
					const percent = total === 0 ? 0 : Math.round((completed/total)*100);

					// æç”»é ˜åŸŸã‚’ã‚¯ãƒªã‚¢
					if(canvas._chartInstance){
						canvas._chartInstance.destroy();
					}

					const ctx = canvas.getContext('2d');
					canvas._chartInstance = new Chart(ctx, {
						type: 'doughnut',
						data: {
							labels: ['é”æˆ', 'æœªé”æˆ'],
							datasets: [{ data: [completed, notDone], backgroundColor: ['#2ecc71','#e74c3c'] }]
						},
						options: {
							cutout: '70%',
							plugins: { legend: { display: false }, tooltip: { enabled: true } },
							maintainAspectRatio: false
						}
					});

					// ä¸­å¤®ã®ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º
					const parent = canvas.parentNode;
					parent.style.position = 'relative';
					let badge = parent.querySelector('.chart-center-badge');
					if(!badge){
						badge = document.createElement('div');
						badge.className = 'chart-center-badge';
						badge.style.position = 'absolute';
						badge.style.left = '50%';
						badge.style.top = '50%';
						badge.style.transform = 'translate(-50%, -50%)';
						badge.style.fontWeight = '700';
						badge.style.color = '#222';
						parent.appendChild(badge);
					}
					badge.textContent = total === 0 ? 'ãƒ‡ãƒ¼ã‚¿ç„¡ã—' : percent + '%';
				}

				fetch('/api/stats/monthly').then(r=>r.json()).then(json=>{
					drawChart(json.completed, json.total);
				}).catch(e=>{
					console.error('stats fetch error', e);
					drawChart(0,0);
				});
			})();
		</script>
	</body>
</html>