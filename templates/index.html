<!doctype html>
<html lang="ja">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Schedule Manager - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
        <style>
            /* å…ƒã®ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ«ã«å®Œå…¨ä¸€è‡´ */
            html, body { height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color:#222; }
            .container { display: flex; flex-direction: column; height: 100vh; }
            
            /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®é…è‰²ã‚’ä¸€è‡´ */
            .header { background: #34495e; color: #fff; padding: 16px 20px; }
            .header h1 { margin: 0; font-size: 1.2rem; }

            /* ä¸Šéƒ¨ãƒ‘ãƒãƒ« */
            .top-area { flex: 0 0 auto; padding: 12px; background: #fff; }
            .top-grid { display: grid; grid-template-columns: 1fr 320px; gap: 16px; }
            .panel { background: #fff; border: 1px solid #e0e0e0; padding: 12px; border-radius: 4px; }
            .panel h2 { margin-top: 0; font-size: 1rem; color: #333; }

            /* ä»Šæ—¥ã®äºˆå®šï¼šã”è¦æœ›ã®ã€Œæ–‡å­—ã ã‘æ¨ªä¸¦ã³ã€ã‚¹ã‚¿ã‚¤ãƒ« */
            .simple-text-list {
                display: flex;
                gap: 20px;
                overflow-x: auto;
                padding: 10px 0;
                font-size: 0.95rem;
                white-space: nowrap;
            }

            /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¨ãƒªã‚¢ï¼šæ§‹é€ ã‚’ä¸€è‡´ */
            .calendar-area { 
                position: relative; 
                flex: 1; 
                background: #fff; 
                padding: 12px; 
                display: flex; 
                flex-direction: column;
            }
            .cal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
            .cal-header .title { font-weight: bold; font-size: 1.1rem; }
            .cal-controls button { background: #34495e; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; margin-left: 4px; }

            .weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: bold; color: #555; padding-bottom: 8px; }
            .days { display: grid; grid-template-columns: repeat(7, 1fr); grid-auto-rows: 1fr; gap: 4px; flex: 1; }
            
            /* æ—¥ä»˜ãƒã‚¹ï¼šå…ƒã®æ ç·šãƒ»é…è‰²ã‚¹ã‚¿ã‚¤ãƒ« */
            .day { 
                background: #fff; 
                border: 1px solid #eee; 
                border-radius: 4px; 
                padding: 6px; 
                position: relative; 
                cursor: pointer;
            }
            .day .date { font-weight: bold; color: #777; font-size: 0.85rem; }
            
            /* ä»Šæ—¥ã®æ—¥ä»˜ï¼ˆé»„è‰²ï¼‰ */
            .day.today { background-color: #fffde7; border: 1px solid #fbc02d; }
            .day.today .date { color: #000; }
            .day.other-month .date { color: #ccc; }

            /* é”æˆç‡ã‚°ãƒ©ãƒ•ï¼šå·¦ä¸‹ã«ã€Œé‡ã­ã‚‹ã€ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
            .calendar-chart {
                position: absolute;
                left: 20px;
                bottom: 20px;
                width: 130px; 
                height: 130px;
                background: rgba(255, 255, 255, 0.98); /* ä¸‹ãŒå°‘ã—é€ã‘ã‚‹ç™½ */
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                z-index: 1000; /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ãƒã‚¹ç›®ã‚ˆã‚Šä¸Šã«è¡¨ç¤º */
            }
            .calendar-chart canvas { width: 100% !important; height: 80px !important; }
            .chart-label { font-size: 0.65rem; color: #888; margin-top: 4px; }
            .chart-center-badge { position: absolute; top: 44%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; font-size: 0.9rem; }

            @media (max-width:700px){ .top-grid { grid-template-columns: 1fr; } .calendar-chart { display: none; } }
        </style>
    </head>
    <body>
        <div class="container">
            <header class="header">
                <h1>Schedule Manager - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            </header>

            <main class="top-area">
                <div class="top-grid">
                    <section class="panel">
                        <h2 id="todayTitle">ä»Šæ—¥ã®äºˆå®š (1æœˆ8æ—¥)</h2>
                        <div class="simple-text-list">
                            {% if today_todos %}
                                {% for todo in today_todos %}
                                    <span>{{ todo.task }} ({{ todo.actual_time }}åˆ†)</span>
                                {% endfor %}
                            {% else %}
                                <span style="color:#888;">äºˆå®šãªã—</span>
                            {% endif %}
                        </div>
                    </section>

                    <aside class="panel">
                        <h2>ã‚„ã‚Šæ®‹ã—</h2>
                        {% if tasks %}
                            <ul style="padding-left: 20px; margin: 0; color: #e74c3c; font-weight: bold; font-size: 0.9rem;">
                                {% for task in tasks %}
                                    <li>{{ task.task }} ({{ task.due_date }})</li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p style="color: #27ae60; margin: 0; font-size: 0.9rem;">ğŸ‰ ã‚„ã‚Šæ®‹ã—ã¯ã‚ã‚Šã¾ã›ã‚“ï¼</p>
                        {% endif %}
                    </aside>
                </div>
            </main>

            <section class="calendar-area">
                <div class="calendar" id="calendarRoot">
                    <div class="cal-header">
                        <div class="title" id="calTitle"></div>
                        <div class="cal-controls">
                            <button id="prevBtn">â—€</button>
                            <button id="nextBtn">â–¶</button>
                        </div>
                    </div>
                    <div class="weekdays">
                        <div>æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div>åœŸ</div>
                    </div>
                    <div class="days" id="daysGrid"></div>
                </div>

                <div class="calendar-chart" id="chartContainer">
                    <canvas id="completionChart"></canvas>
                    <div class="chart-label">ä»Šæœˆã®é”æˆç‡</div>
                </div>
            </section>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
        (function(){
            const daysGrid = document.getElementById('daysGrid');
            const titleEl = document.getElementById('calTitle');
            const today = new Date();
            let current = new Date(); current.setDate(1);

            function render(monthDate){
                daysGrid.innerHTML = '';
                const year = monthDate.getFullYear();
                const month = monthDate.getMonth();
                titleEl.textContent = `${year}å¹´ ${month+1}æœˆ`;

                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month+1, 0).getDate();
                const prevMonthLastDay = new Date(year, month, 0).getDate();

                for(let i=0; i<42; i++){
                    const cell = document.createElement('div');
                    cell.className = 'day';
                    let d;
                    if(i < firstDay){
                        cell.classList.add('other-month');
                        d = prevMonthLastDay - (firstDay - i - 1);
                    } else if(i >= firstDay + daysInMonth){
                        cell.classList.add('other-month');
                        d = i - (firstDay + daysInMonth) + 1;
                    } else {
                        d = i - firstDay + 1;
                        const ds = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                        if(year===today.getFullYear() && month===today.getMonth() && d===today.getDate()) cell.classList.add('today');
                        cell.onclick = () => location.href = `/due_date/${ds}`;
                    }
                    cell.innerHTML = `<div class="date">${d}</div>`;
                    daysGrid.appendChild(cell);
                }
            }

            document.getElementById('prevBtn').onclick = () => { current.setMonth(current.getMonth()-1); render(current); };
            document.getElementById('nextBtn').onclick = () => { current.setMonth(current.getMonth()+1); render(current); };
            render(current);

            // ã‚°ãƒ©ãƒ•APIå–å¾—ã¨æç”»
            fetch('/api/stats/monthly').then(r=>r.json()).then(json=>{
                const percent = json.total === 0 ? 0 : Math.round((json.completed/json.total)*100);
                new Chart(document.getElementById('completionChart').getContext('2d'), {
                    type: 'doughnut',
                    data: { datasets: [{ data: [json.completed, Math.max(0, json.total - json.completed)], backgroundColor: ['#2ecc71', '#e74c3c'], borderWidth: 0 }] },
                    options: { cutout: '75%', plugins: { legend: { display: false } }, maintainAspectRatio: false }
                });
                const badge = document.createElement('div');
                badge.className = 'chart-center-badge';
                badge.textContent = percent + '%';
                document.getElementById('chartContainer').appendChild(badge);
            }).catch(() => {
                document.getElementById('chartContainer').innerHTML = "<div class='chart-label' style='padding:40px 0;'>ãƒ‡ãƒ¼ã‚¿ç„¡ã—</div>";
            });
        })();
        </script>
    </body>
</html>